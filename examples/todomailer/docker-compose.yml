services:
  todomailer:
    build:
      context: ../..
      dockerfile: ./examples/todomailer/Dockerfile
    ports:
      - "8080:8080"
    environment:
      - PORT=8080
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://jaeger:4318
      - DB_HOST=postgres
      - DB_PORT=5432
      - DB_NAME=todomailerdb
      - VAULT_ADDR=http://vault:8200
      - VAULT_TOKEN=root-token
      - VAULT_MOUNT_PATH=secret
      - VAULT_SECRET_PATH=todomailer
    depends_on:
      jaeger:
        condition: service_started
      postgres:
        condition: service_healthy
      vault:
        condition: service_healthy

  jaeger:
    image: jaegertracing/all-in-one:1.76.0
    ports:
      - "6831:6831/udp"
      - "16686:16686"
      - "4318:4318"

  postgres:
    image: postgres:15
    environment:
      POSTGRES_USER: todomailer
      POSTGRES_PASSWORD: todomailerpass
      POSTGRES_DB: todomailerdb
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U todomailer"]
      interval: 10s
      timeout: 5s
      retries: 5

  vault:
    image: hashicorp/vault:1.15
    ports:
      - "8200:8200"
    environment:
      VAULT_DEV_ROOT_TOKEN_ID: root-token
      VAULT_DEV_LISTEN_ADDRESS: 0.0.0.0:8200
      VAULT_ADDR: http://127.0.0.1:8200
    cap_add:
      - IPC_LOCK
    healthcheck:
      test: ["CMD", "wget", "--spider", "--proxy", "off", "http://127.0.0.1:8200/v1/sys/health?standbyok=true"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    volumes:
      - ./scripts/vault-init.sh:/vault-init.sh:ro
    entrypoint: /bin/sh
    command: 
      - -c
      - |
        vault server -dev -dev-root-token-id=root-token -dev-listen-address=0.0.0.0:8200 &
        VAULT_PID=$$!
        sleep 5
        sh /vault-init.sh
        wait $$VAULT_PID